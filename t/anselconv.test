#!/bin/sh

# For use outside Makefile
if [ -z "$srcdir" ]
then
  srcdir=.
fi
builddir=`pwd`

export GCONV_PATH=.:$GCONV_PATH
ln -s $srcdir/../data/gedcom.enc .
ln -s $builddir/../iconv/glibc/.libs/ANSI_Z39.47.so .
ln -s $srcdir/../iconv/glibc/gconv-modules .

retval=0

if [ "$ICONV_PATH" ]
then
  export PATH=$ICONV_PATH:$PATH
fi

echo "Testing conversion from ANSEL to UTF-8" >> testgedcom.out
iconv -f ANSEL -t UTF-8 input/ansel.ged > anselutf8.out
if ! diff input/anselutf8.ged anselutf8.out >> testgedcom.out
then
  retval=1
else
  echo "Testing conversion from UTF-8 to ANSEL" >> testgedcom.out
  iconv -f UTF-8 -t ANSEL input/anselutf8.ged > ansel.out
  if ! diff input/ansel.ged ansel.out >> testgedcom.out
  then
    retval=1
  fi
fi

rm gedcom.enc
rm ANSI_Z39.47.so
rm gconv-modules
exit $retval
